<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Admin - Veera Draw</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header style="text-align:center;">
    <img src="logo.png" alt="Veera logo" style="max-height:80px;"/>
  </header>

  <div class="container">
    <h1>Admin Panel</h1>

    <label>Show Date/Time:</label>
    <input type="datetime-local" id="showTime" />

    <label>Audience Size:</label>
    <input type="number" id="audience" />

    <label>Keychains:</label>
    <input type="number" id="keychains" />

    <label>T-Shirts:</label>
    <input type="number" id="tshirts" />

    <label>Duration (sec):</label>
    <input type="number" id="duration" value="45" />

    <button id="startBtn">Start Draw</button>
    <h3 id="adminTimer">Time left: 0s</h3>
    <h3 id="entryCount"></h3>
    <div id="winnerSection"></div>
    <button id="genBtn">Generate Winners</button>
    <button id="resetBtn">Reset Draw</button>
    <button onclick="window.location.href='reports.html'">View Reports</button>

    <hr>
    <button id="intervalBtn" style="background:#ff9800;">Interval Block</button>
    <button id="mainPageBtn" style="background:#4caf50;">Main Page</button>
  </div>

  <!-- Shared firebase init -->
  <script type="module" src="firebase-init.js"></script>
  <script type="module">
    import { db } from './firebase-init.js';
    import { doc, setDoc, getDoc, onSnapshot, collection, query, where, getDocs, addDoc, deleteDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const stateDocRef = doc(db, 'state', 'draw');

    document.getElementById("startBtn").addEventListener("click", async () => {
      if (!confirm("Start a new draw? This will clear any current entries.")) return;
      const drawId = Date.now().toString();
      const state = {
        drawId,
        state: "running",
        startTime: Date.now(),
        duration: parseInt(document.getElementById("duration").value, 10),
        audience: parseInt(document.getElementById("audience").value, 10),
        keychains: parseInt(document.getElementById("keychains").value, 10),
        tshirts: parseInt(document.getElementById("tshirts").value, 10),
      };
      await setDoc(stateDocRef, state);
      alert("Draw started successfully!");
    });

    document.getElementById("genBtn").addEventListener("click", async () => {
      if (!confirm("Generate winners now? This will end the draw.")) return;
      const stateSnap = await getDoc(stateDocRef);
      if (!stateSnap.exists()) return alert("No active draw.");
      const state = stateSnap.data();
      const entriesQ = query(collection(db, 'entries'), where('drawId', '==', state.drawId));
      const entriesSnap = await getDocs(entriesQ);
      let pool = entriesSnap.docs.map(d => ({ id: d.id, ...d.data() }));

      const pickRandomUnique = (count) => {
        const res = [];
        while (pool.length && res.length < count) {
          const idx = Math.floor(Math.random() * pool.length);
          res.push(pool.splice(idx, 1)[0]);
        }
        return res;
      };

      const keychainWinners = pickRandomUnique(state.keychains || 0);
      while (keychainWinners.length < (state.keychains || 0)) keychainWinners.push({ name: "Nil", seat: "Nil" });

      const tshirtWinners = pickRandomUnique(state.tshirts || 0);
      while (tshirtWinners.length < (state.tshirts || 0)) tshirtWinners.push({ name: "Nil", seat: "Nil" });

      const winners = [...keychainWinners, ...tshirtWinners];

      const finishedState = {
        ...state,
        state: "finished",
        endTime: Date.now(),
        winners,
      };
      await setDoc(stateDocRef, finishedState);

      await addDoc(collection(db, 'reports'), {
        drawId: state.drawId,
        showTime: document.getElementById('showTime').value,
        audience: state.audience,
        keychains: state.keychains,
        tshirts: state.tshirts,
        winners,
        createdAt: serverTimestamp()
      });

      alert("Winners generated and reported.");
    });

    document.getElementById("resetBtn").addEventListener("click", async () => {
      if (!confirm("Reset current draw? This clears the draw state but keeps reports.")) return;
      await deleteDoc(stateDocRef);
      alert("Current draw reset.");
    });

    document.getElementById("intervalBtn").addEventListener("click", async () => {
      await setDoc(stateDocRef, { state: "interval" }, { merge: true });
      alert("Interval mode activated!");
    });

    document.getElementById("mainPageBtn").addEventListener("click", async () => {
      await setDoc(stateDocRef, { state: "running" }, { merge: true });
      alert("Main page activated!");
    });
  </script>
</body>
</html>
