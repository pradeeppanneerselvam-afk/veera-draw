<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Veera Draw Reports</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<header><img src="logo.png" alt="Veera logo"></header>
<div class="container">
  <h1>Draw Reports</h1>
  <div id="reportsContainer"></div>
  <button id="exportBtn">Export CSV</button>
  <button id="clearBtn">Clear Reports</button>
</div>


<!-- Shared config/init -->
<script type="module" src="firebase-init.js"></script>
<script type="module">
  import { db } from './firebase-init.js';
  import { collection, query, orderBy, getDocs, writeBatch, doc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  if (!db) alert('Firebase not initialized. Check firebase-init.js');

  async function loadReports() {
    const q = query(collection(db, 'reports'), orderBy('createdAt', 'desc'));
    const snaps = await getDocs(q);
    const reports = snaps.docs.map(d => ({ id: d.id, ...d.data() }));
    const container = document.getElementById('reportsContainer');
    if (!reports.length) {
      container.innerHTML = '<p>No reports found.</p>';
      return;
    }
    let html = '<div>';
    reports.forEach(r => {
      html += `<div style="margin-bottom:18px;padding:12px;border-radius:8px;background:#fff;">
        <strong>Draw ID:</strong> ${r.drawId} <br>
        <strong>Show Time:</strong> ${r.showTime || '-'} <br>
        <strong>Audience:</strong> ${r.audience || '-'} <br>
        <strong>Keychains:</strong> ${r.keychains || 0} <br>
        <strong>T-Shirts:</strong> ${r.tshirts || 0} <br>
        <strong>Winners:</strong>
        <table class="winner-table" style="margin-top:8px;">
          <tr><th>Prize</th><th>Name</th><th>Seat</th></tr>
          ${r.winners && r.winners.length ? r.winners.map((w,i) => {
            const prize = i < (r.keychains||0) ? `Keychain #${i+1}` : `T-Shirt #${i - (r.keychains||0) + 1}`;
            return `<tr><td>${prize}</td><td>${w.name}</td><td>${w.seat}</td></tr>`;
          }).join('') : '<tr><td colspan="3">No winners</td></tr>'}
        </table>
        <button onclick='copyWinners(${JSON.stringify(r)})'>📋 Copy Winners</button>
      </div>`;
    });
    html += '</div>';
    container.innerHTML = html;
  }

  // Copy winners list (only names + seats, with date header)
  window.copyWinners = function(report) {
    // ✅ Only change: strip time from date
    const dateOnly = report.showTime ? report.showTime.split("T")[0] : '-';
    let text = `📅 Date: ${dateOnly}\n🏆 Winners List\n\n`;
    if (report.winners && report.winners.length) {
      text += report.winners.map(w => `🎉 ${w.name} - Seat ${w.seat}`).join("\n");
    } else {
      text += "No winners";
    }
    navigator.clipboard.writeText(text).then(() => {
      alert("Winners copied to clipboard!");
    });
  }

  document.getElementById('exportBtn').addEventListener('click', async () => {
    const q = query(collection(db, 'reports'), orderBy('createdAt','desc'));
    const snaps = await getDocs(q);
    const reports = snaps.docs.map(d => ({ id: d.id, ...d.data() }));
    if (!reports.length) return alert('No reports to export');
    let csv = 'DrawId,ShowTime,Audience,Keychains,TShirts,Winners\n';
    reports.forEach(r => {
      const winners = r.winners ? r.winners.map(w => `${w.name} (${w.seat})`).join('; ') : '';
      // Escape quotes by doubling them
      const esc = v => (`${v}`.replace(/"/g,'""'));
      csv += `"${esc(r.drawId)}","${esc(r.showTime || '')}",${r.audience || 0},${r.keychains || 0},${r.tshirts || 0},"${esc(winners)}"\n`;
    });
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'reports.csv'; a.click();
  });

  document.getElementById('clearBtn').addEventListener('click', async () => {
    if (!confirm('This will permanently delete ALL reports. Are you sure?')) return;
    const snaps = await getDocs(collection(db, 'reports'));
    const batch = writeBatch(db);
    snaps.forEach(d => batch.delete(doc(db, 'reports', d.id)));
    await batch.commit();
    alert('All reports deleted.');
    loadReports();
  });

  loadReports();
</script>
</body>
</html>
