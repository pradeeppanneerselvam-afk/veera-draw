<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Veera Cinemas Lucky Draw</title>
<link rel="stylesheet" href="style.css" />
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f7f7f7;
    margin: 0;
    padding: 0;
    text-align: center;
  }
  header img {
    max-width: 150px;
    margin-top: 15px;
  }
  .card {
    max-width: 500px;
    background: white;
    margin: 20px auto;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
  input {
    width: 90%;
    padding: 10px;
    margin-top: 8px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 16px;
  }
  button {
    margin-top: 15px;
    padding: 12px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
    width: 95%;
  }
  .btn-whatsapp {
    display: block;
    background: #25D366;
    padding: 12px;
    margin-top: 12px;
    border-radius: 8px;
    color: white;
    font-weight: bold;
    text-decoration: none;
    font-size: 18px;
  }
  .btn-insta {
    display: block;
    background: #E4405F;
    padding: 12px;
    margin-top: 12px;
    border-radius: 8px;
    color: white;
    font-weight: bold;
    text-decoration: none;
    font-size: 18px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 8px;
  }
  /* Popup modal */
  .modal {
    display: none;
    position: fixed;
    z-index: 999;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    justify-content: center; align-items: center;
  }
  .modal-content {
    background: white;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    width: 80%;
    max-width: 300px;
  }
  .modal-content h2 {
    margin-top: 0;
    color: green;
  }
</style>
</head>
<body>

<header>
  <img src="logo.png" alt="Veera Cinemas Logo">
</header>

<!-- Welcome Screen -->
<div id="welcomeScreen" class="card">
  <h1>Welcome to Coolie!</h1>
  <p>ðŸŽ‰ Veera Cinemas celebrates with an exciting Lucky Draw! Join now for a chance to win amazing prizes.</p>
  <a href="https://chat.whatsapp.com/FjKFb5hAOuBDs4HEpenxnB?mode=ac_t" target="_blank" class="btn-whatsapp">ðŸ“² Join WhatsApp Group</a>
  <a href="https://www.instagram.com/veeracinemas?igsh=aGcxYndmdGs4MTRy" target="_blank" class="btn-insta">ðŸ“¸ Follow on Instagram</a>
  <p>Follow us to participate in the Lucky Draw and grab your chance to win exclusive goodies!</p>
</div>

<!-- Entry Form -->
<div id="entryForm" class="card" style="display:none;">
  <h2>Enter the Lucky Draw</h2>
  <input type="text" id="nameInput" placeholder="Your Name" />
  <input type="text" id="seatInput" placeholder="Seat Number" />
  <button id="submitEntry">Submit Entry</button>
  <h3 id="timerDisplay"></h3>
</div>

<!-- Draw Closed Message -->
<div id="drawClosedMsg" class="card" style="display:none;">
  <h2>Draw closed</h2>
  <p>Winners will be announced shortly...</p>
</div>

<!-- Winners Section -->
<div id="winnersSection" class="card" style="display:none;">
  <h2>Winners</h2>
  <table id="winnersTable">
    <tr><th>Name</th><th>Seat</th></tr>
  </table>
</div>

<!-- Success Modal -->
<div id="successModal" class="modal">
  <div class="modal-content">
    <h2>âœ… Success!</h2>
    <p>Your entry has been submitted.</p>
    <button onclick="closeModal()">OK</button>
  </div>
</div>

<audio id="bgMusic" src="bg.mp3" preload="auto" loop></audio>
<audio id="winnerMusic" src="winner.mp3" preload="auto"></audio>

<script type="module">
import { db } from './firebase-init.js';
import { doc, onSnapshot, addDoc, collection } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

const stateDocRef = doc(db, 'state', 'draw');
let currentDrawId = null;
const bgMusic = document.getElementById("bgMusic");
const winnerMusic = document.getElementById("winnerMusic");

let userTimerInterval;  // Added global timer interval

function tryPlayBgMusic() {
  bgMusic.currentTime = 0;
  bgMusic.play().catch(() => {
    document.body.addEventListener("click", () => {
      bgMusic.play();
    }, { once: true });
  });
}

onSnapshot(stateDocRef, (snap) => {
  const data = snap.exists() ? snap.data() : null;
  if (!data) {
    showWelcome();
    stopAllMusic();
    return;
  }
  
  if (data.state === "running") {
    currentDrawId = data.drawId;
    showEntryForm(data);
    tryPlayBgMusic();
  } 
  else if (data.state === "finished") {
    showWinners(data.winners || []);
    stopBgMusic();
    winnerMusic.play();
  }
});

function showWelcome() {
  document.getElementById("welcomeScreen").style.display = "block";
  document.getElementById("entryForm").style.display = "none";
  document.getElementById("drawClosedMsg").style.display = "none";
  document.getElementById("winnersSection").style.display = "none";
  if (userTimerInterval) clearInterval(userTimerInterval);
}

function showEntryForm(data) {
  document.getElementById("welcomeScreen").style.display = "none";
  document.getElementById("entryForm").style.display = "block";
  document.getElementById("drawClosedMsg").style.display = "none";
  document.getElementById("winnersSection").style.display = "none";

  if (userTimerInterval) clearInterval(userTimerInterval);

  // Convert startTime to milliseconds if needed
  let startTimeMs = data.startTime;
  if (data.startTime && typeof data.startTime.toMillis === 'function') {
    startTimeMs = data.startTime.toMillis();
  } else if (typeof data.startTime === 'number' && data.startTime < 1e12) {
    startTimeMs = data.startTime * 1000;
  }

  const endTime = startTimeMs + data.duration * 1000;
  let secondsLeft = Math.floor((endTime - Date.now()) / 1000);
  if (secondsLeft < 0) secondsLeft = 0;

  const timerEl = document.getElementById("timerDisplay");
  timerEl.textContent = `Time left: ${secondsLeft}s`;

  userTimerInterval = setInterval(() => {
    secondsLeft--;
    if (secondsLeft <= 0) {
      clearInterval(userTimerInterval);
      showDrawClosedMsg();
      return;
    }
    timerEl.textContent = `Time left: ${secondsLeft}s`;
  }, 1000);
}

function showDrawClosedMsg() {
  document.getElementById("entryForm").style.display = "none";
  document.getElementById("drawClosedMsg").style.display = "block";
  if (userTimerInterval) clearInterval(userTimerInterval);
}

function showWinners(winners) {
  document.getElementById("welcomeScreen").style.display = "none";
  document.getElementById("entryForm").style.display = "none";
  document.getElementById("drawClosedMsg").style.display = "none";
  document.getElementById("winnersSection").style.display = "block";
  
  const table = document.getElementById("winnersTable");
  table.innerHTML = "<tr><th>Name</th><th>Seat</th></tr>";
  winners.forEach(w => {
    table.innerHTML += `<tr><td>${w.name}</td><td>${w.seat}</td></tr>`;
  });
}

function stopBgMusic() {
  bgMusic.pause();
  bgMusic.currentTime = 0;
}

function stopAllMusic() {
  stopBgMusic();
  winnerMusic.pause();
  winnerMusic.currentTime = 0;
}

document.getElementById("submitEntry").addEventListener("click", async () => {
  const name = document.getElementById("nameInput").value.trim();
  const seat = document.getElementById("seatInput").value.trim();
  if (!name || !seat) {
    alert("Please enter your name and seat.");
    return;
  }
  if (!currentDrawId) {
    alert("No active draw.");
    return;
  }
  await addDoc(collection(db, 'entries'), {
    drawId: currentDrawId,
    name,
    seat
  });
  document.getElementById("nameInput").value = "";
  document.getElementById("seatInput").value = "";
  document.getElementById("successModal").style.display = "flex";
});

window.closeModal = function() {
  document.getElementById("successModal").style.display = "none";
};
</script>

</body>
</html>
