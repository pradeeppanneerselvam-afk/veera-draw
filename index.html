<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Veera Draw Entry</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header>
      <img src="logo.png" alt="Veera logo" />
    </header>

    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="container" style="text-align:center;">
      <h1>Welcome to Coolie!</h1>
      <p style="font-size:1.1em; margin-top:10px;">
        ðŸŽ‰ Veera Cinemas celebrates with an exciting Lucky Draw!  
        Join now for a chance to win amazing prizes.
      </p>
      <div style="margin-top:20px;">
        <a href="https://chat.whatsapp.com/FjKFb5hAOuBDs4HEpenxnB?mode=ac_t" target="_blank" style="display:inline-block; padding:12px 20px; background:#25D366; color:#fff; border-radius:8px; font-weight:bold; text-decoration:none; margin:5px;">ðŸ’¬ Join WhatsApp Group</a>
        <a href="https://www.instagram.com/veeracinemas?igsh=aGcxYndmdGs4MTRy" target="_blank" style="display:inline-block; padding:12px 20px; background:#E4405F; color:#fff; border-radius:8px; font-weight:bold; text-decoration:none; margin:5px;">ðŸ“¸ Follow on Instagram</a>
      </div>
      <p style="margin-top:20px; font-style:italic; color:#555;">
        Follow us to participate in the Lucky Draw and grab your chance to win exclusive goodies!
      </p>
    </div>

    <h1>Lucky Draw</h1>
    <div id="timer" class="timer"></div>

    <div id="entryForm" class="container" style="display:none;">
      <form id="drawForm">
        <input
          type="text"
          id="name"
          placeholder="Your Name"
          required
          autocomplete="name"
        />
        <input
          type="text"
          id="seat"
          placeholder="Seat Number"
          required
          autocomplete="off"
        />
        <button type="submit">Submit Entry</button>
      </form>
      <div
        id="submitMsg"
        style="text-align: center; margin-top: 8px; color: #5e1d7d"
      ></div>
    </div>

    <div id="message" class="container"></div>

    <!-- Shared Firebase init -->
    <script type="module" src="firebase-init.js"></script>
    <script type="module">
      import { db } from './firebase-init.js';
      import { doc, getDoc, onSnapshot, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

      if (!db) {
        document.getElementById('message').textContent = 'Firebase not initialized.';
      }

      function formatSecondsLeft(msEnd) {
        return Math.max(0, Math.floor((msEnd - Date.now()) / 1000));
      }

      const stateDocRef = doc(db, 'state', 'draw');
      let localCountdownInterval;

      function startLocalCountdown(seconds) {
        clearInterval(localCountdownInterval);
        let left = seconds;
        document.getElementById('timer').textContent = `Time left: ${left}s`;
        localCountdownInterval = setInterval(() => {
          left--;
          document.getElementById('timer').textContent = `Time left: ${Math.max(0,left)}s`;
          if (left <= 0) {
            clearInterval(localCountdownInterval);
            hideForm();
          }
        }, 1000);
      }

      function showForm() {
        document.getElementById('welcomeScreen').style.display = 'none';
        document.getElementById('entryForm').style.display = 'block';
        document.getElementById('message').textContent = '';
        document.getElementById('submitMsg').textContent = '';
      }

      function hideForm() {
        document.getElementById('entryForm').style.display = 'none';
      }

      function showWelcome() {
        document.getElementById('welcomeScreen').style.display = 'block';
        document.getElementById('entryForm').style.display = 'none';
        document.getElementById('message').innerHTML = '';
      }

      // Realtime listener for draw state
      onSnapshot(stateDocRef, (snap) => {
        const data = snap.exists() ? snap.data() : null;

        if (!data) {
          showWelcome();
          document.getElementById('timer').textContent = '';
          return;
        }

        if (data.state !== 'running') {
          document.getElementById('bgAudio').pause();
          document.getElementById('bgAudio').currentTime = 0;
          hideForm();
          document.getElementById('timer').textContent = '';
          if (data.state === 'finished' && data.winners) {
            document.getElementById('winnerAudio').play().catch(err => console.log('Autoplay blocked:', err));
            showWinners(data);
          } else {
            showWelcome();
          }
          return;
        }

        // Draw running
        const endTime = data.startTime + data.duration * 1000;
        const left = formatSecondsLeft(endTime);
        showForm();
        startLocalCountdown(left);
        document.getElementById('bgAudio').play().catch(err => console.log('Autoplay blocked:', err));
      });

      // Submit entry
      document.getElementById('drawForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('name').value.trim();
        const seat = document.getElementById('seat').value.trim();
        if (!name || !seat) return;

        const stateSnap = await getDoc(stateDocRef);
        if (!stateSnap.exists()) {
          document.getElementById('submitMsg').textContent = 'No active draw.';
          return;
        }
        const state = stateSnap.data();
        if (state.state !== 'running') {
          document.getElementById('submitMsg').textContent = 'Draw not running.';
          return;
        }
        try {
          await addDoc(collection(db, 'entries'), {
            drawId: state.drawId,
            name,
            seat,
            timestamp: serverTimestamp()
          });
          document.getElementById('submitMsg').textContent = 'Entry submitted â€” good luck!';
          document.getElementById('drawForm').reset();
        } catch (err) {
          console.error(err);
          document.getElementById('submitMsg').textContent = 'Submission failed â€” try again.';
        }
      });

      // Show winners (Name + Seat only)
      function showWinners(data) {
        document.getElementById('welcomeScreen').style.display = 'none';
        if (!data.winners || !data.winners.length) {
          document.getElementById('message').textContent = 'No winners.';
          return;
        }
        let html = `<h3>Winners</h3><table class="winner-table"><tr><th>Name</th><th>Seat</th></tr>`;
        data.winners.forEach((w, i) => {
          const winnerData = w || { name: 'Nil', seat: 'Nil' };
          html += `<tr class="winner-row" id="winner-${i+1}"><td>${winnerData.name}</td><td>${winnerData.seat}</td></tr>`;
        });
        html += `</table>`;
        document.getElementById('message').innerHTML = html;
        for (let i = 0; i < data.winners.length; i++) {
          setTimeout(() => {
            const el = document.getElementById(`winner-${i + 1}`);
            if (el) el.classList.add('show');
          }, i * 800);
        }
      }
    </script>

    <!-- Audio files -->
    <audio id="bgAudio" src="bg.mp3" preload="auto" loop></audio>
    <audio id="winnerAudio" src="winner.mp3" preload="auto"></audio>
  </body>
</html>
