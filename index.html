<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Veera Cinemas Lucky Draw</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
  <img src="logo.png" alt="Veera Cinemas Logo">
</header>

<div class="container card">
  <h1>Lucky Draw Entry</h1>
  <label for="name">Your Name:</label>
  <input type="text" id="name" placeholder="Enter your name">

  <label for="seat">Seat Number:</label>
  <input type="text" id="seat" placeholder="Enter your seat number">

  <button id="submitBtn">Submit Entry</button>

  <h3 id="timer"></h3>
  <div id="winnerSection"></div>
</div>

<audio id="bgMusic" src="bg.mp3" preload="auto" loop></audio>
<audio id="winnerMusic" src="winner.mp3" preload="auto"></audio>

<script type="module">
  import { db } from './firebase-init.js';
  import { doc, onSnapshot, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  const stateDocRef = doc(db, 'state', 'draw');

  const bgMusic = document.getElementById('bgMusic');
  const winnerMusic = document.getElementById('winnerMusic');

  function playBgMusic() {
    bgMusic.play().catch(err => console.warn('Autoplay blocked:', err));
  }

  function playWinnerMusic() {
    winnerMusic.play().catch(err => console.warn('Autoplay blocked:', err));
  }

  document.getElementById('submitBtn').addEventListener('click', async () => {
    const name = document.getElementById('name').value.trim();
    const seat = document.getElementById('seat').value.trim();
    if (!name || !seat) {
      alert('Please enter your name and seat number.');
      return;
    }
    try {
      await addDoc(collection(db, 'entries'), {
        name,
        seat,
        drawId: currentDrawId,
        createdAt: serverTimestamp()
      });
      alert('✅ Entry submitted successfully!');
      document.getElementById('name').value = '';
      document.getElementById('seat').value = '';
    } catch (err) {
      console.error(err);
      alert('Failed to submit entry.');
    }
  });

  let currentDrawId = null;
  let timerInterval;

  onSnapshot(stateDocRef, (snap) => {
    const data = snap.exists() ? snap.data() : null;
    if (!data) {
      document.getElementById('timer').textContent = '';
      document.getElementById('winnerSection').innerHTML = '';
      return;
    }

    // NEW — Redirect if Interval Block
    if (data.state === 'interval') {
      window.location.href = 'interval.html';
      return;
    }

    if (data.state === 'running') {
      currentDrawId = data.drawId;
      playBgMusic();
      const endTime = data.startTime + data.duration * 1000;
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        const left = Math.max(0, Math.floor((endTime - Date.now()) / 1000));
        document.getElementById('timer').textContent = `Time left: ${left}s`;
        if (left <= 0) {
          clearInterval(timerInterval);
          document.getElementById('timer').textContent = 'Draw closed. Winners will be announced shortly...';
        }
      }, 1000);
      document.getElementById('winnerSection').innerHTML = '';
    } else if (data.state === 'finished') {
      playWinnerMusic();
      document.getElementById('timer').textContent = 'Draw closed';
      showWinnersTable(data.winners || []);
    }
  });

  function showWinnersTable(winners) {
    if (!winners.length) {
      document.getElementById('winnerSection').innerHTML = '<p>No winners.</p>';
      return;
    }
    let html = `<h3>Winners</h3><table class="winner-table"><tr><th>Name</th><th>Seat</th></tr>`;
    winners.forEach((w, i) => {
      html += `<tr class="winner-row"><td>${w.name}</td><td>${w.seat}</td></tr>`;
    });
    html += `</table>`;
    document.getElementById('winnerSection').innerHTML = html;
  }
</script>

</body>
</html>
